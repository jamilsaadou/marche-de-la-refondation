// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model DemandeExposant {
  id                     String   @id @default(cuid())
  numeroReference        String   @unique
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  status                 String   @default("EN_ATTENTE") // EN_ATTENTE, APPROUVE, REJETE
  
  // Questions préliminaires
  typeInscription        String   // "moi-meme" ou "autre-personne"
  localisation           String   // "niamey" ou "region"
  region                 String?  // Si en région
  
  // Informations personnelles
  nom                    String
  prenom                 String
  nationalite            String
  age                    Int
  sexe                   String
  telephone              String
  email                  String?
  adresse                String
  
  // Informations entreprise
  nomEntreprise          String?
  secteurActivite        String
  registreCommerce       String?
  
  // Description de l'activité
  produitsProposes       String   @db.Text
  listeProduitsDetaillee String   @db.Text
  capaciteProduction     String   @db.Text
  experienceAnterieure   String   @db.Text
  
  // Informations complémentaires pour l'évaluation
  origineMatieresPremieres     String?
  transformationAuNiger        String?
  innovation                   String?  @db.Text
  regulariteApprovisionnement  String?
  adaptationDemandeCroissante  String?
  nombreFemmes                 Int?
  nombreJeunes                 Int?
  certificatConformite         String?
  
  // Informations demande
  sitePreference         String
  tailleKiosque          String
  nombreEmployes         Int
  
  // Engagement
  acceptEngagement       Boolean
  acceptFraisStand       Boolean
  
  // Documents (URLs des fichiers uploadés)
  carteIdentiteUrl       String?
  registreCommerceDocUrl String?
  listeProduitsFileUrl   String?
  photoProduitsUrls      String?  @db.Text // JSON array des URLs des photos de produits
  
  // Notes administratives
  notesAdmin             String?  @db.Text
  dateDecision           DateTime?
  raisonRejet            String?  @db.Text
  
  // Relations
  evaluations            Evaluation[]
  
  @@index([numeroReference])
  @@index([status])
  @@index([createdAt])
  @@index([telephone])
  @@index([email])
}

model Admin {
  id          String       @id @default(cuid())
  email       String       @unique
  password    String
  nom         String
  prenom      String
  role        String       @default("ADMIN") // ADMIN, SUPER_ADMIN, JURY, PRESIDENT_JURY
  actif       Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  evaluations Evaluation[]
  
  @@index([email])
  @@index([role])
}

model Evaluation {
  id                String   @id @default(cuid())
  demandeId         String
  demande           DemandeExposant @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  evaluateurId      String
  evaluateur        Admin    @relation(fields: [evaluateurId], references: [id])
  
  // Scores par critère (stockés en JSON)
  scores            String   @db.Text // JSON des scores
  commentaires      String?  @db.Text // JSON des commentaires
  scoreTotal        Float    // Score total calculé
  
  decision          String?  // APPROUVE, REJETE (seulement pour le président)
  estValidationFinale Boolean @default(false) // true si c'est la validation finale du président
  dateEvaluation    DateTime @default(now())
  
  @@unique([demandeId, evaluateurId]) // Un évaluateur ne peut évaluer qu'une seule fois une demande
  @@index([demandeId])
  @@index([evaluateurId])
  @@index([dateEvaluation])
}

model Log {
  id            String   @id @default(cuid())
  userId        String?  // ID de l'utilisateur (nullable pour les actions système)
  userEmail     String?  // Email de l'utilisateur pour référence
  userName      String?  // Nom complet de l'utilisateur
  userRole      String?  // Rôle de l'utilisateur
  
  action        String   // Type d'action (LOGIN, LOGOUT, CREATE, UPDATE, DELETE, APPROVE, REJECT, etc.)
  entity        String?  // Entité concernée (DEMANDE, USER, EVALUATION, etc.)
  entityId      String?  // ID de l'entité concernée
  
  description   String   @db.Text // Description détaillée de l'action
  metadata      String?  @db.Text // Métadonnées supplémentaires en JSON
  
  ipAddress     String?  // Adresse IP de l'utilisateur
  userAgent     String?  @db.Text // User agent du navigateur
  
  status        String   @default("SUCCESS") // SUCCESS, ERROR, WARNING
  errorMessage  String?  @db.Text // Message d'erreur si applicable
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@index([status])
}
